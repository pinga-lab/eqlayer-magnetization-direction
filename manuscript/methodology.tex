\section{Methodology}
\label{sec:methodology}

\subsection{Fundamentals of magnetic equivalent layer and the positive magnetic-moment distribution}
\label{subsec:mag_eqlayer}

Let $\Delta T(x, y, z)$ be the total-field anomaly produced by a set of magnetic
sources at a point $(x, y, z)$ referred to a topocentric Cartesian coordinate system 
with $x$-, $y$- and $z$-axis being oriented to north, east and down, respectively.
Consider that the main geomagnetic field has a constant inclination $I_{0}$ and declination
$D_{0}$ throughout the study area, so that its direction can be defined by the unit vector
\begin{equation}
\hat{\mathbf{F}}_{0} = \begin{bmatrix}
\cos I_{0} \cos D_{0} \\
\cos I_{0} \sin D_{0} \\
\sin I_{0}
\end{bmatrix} \: .
\label{eq:main_field}
\end{equation}
Additionally, consider that the magnetic sources have a constant total magnetization 
direction defined by the unit vector
\begin{equation}
\hat{\mathbf{m}}(\mathbf{q}) = \begin{bmatrix}
\cos {I} \cos {D} \\
\cos {I} \sin {D} \\
\sin {I}
\end{bmatrix} \: ,
\label{eq:mag_vec}
\end{equation}
where the constants $I$ and $D$ represent its inclination and declination, respectively,
and $\mathbf{q}$ is a $2 \times 1$ vector given by:
\begin{equation}
\mathbf{q} = \begin{bmatrix}
I \\ 
D
\end{bmatrix} \: .
\label{eq:q_vector}
\end{equation}
For convenience, we call $\mathbf{q}$ as magnetization direction vector.
In this case, the total-field anomaly $\Delta T(x, y, z)$ can be written as follows:
\begin{equation}
\Delta T(x, y, z) = \gamma_{m} \, \hat{\mathbf{F}}_{0}^{\top} \mathbf{M}(x, y, z) \: 
\hat{\mathbf{m}}(\mathbf{q}) \: ,
\label{eq:tfanomaly}
\end{equation}
where $\gamma_{m} = 10^{-9} \frac{\mu_{0}}{4 \pi}$ (in $n \, H / m $), 
$\mu_{0}$ is the vacuum magnetic permeability and $\mathbf{M}(x, y, z)$ is a matrix 
given by
\begin{equation}
	\mathbf{M}(x, y, z) = \begin{bmatrix}
		\partial_{xx} \Gamma(x, y, z) & 
		\partial_{xy} \Gamma(x, y, z) &
		\partial_{xz} \Gamma(x, y, z) \\
		\partial_{xy} \Gamma(x, y, z) & 
		\partial_{yy} \Gamma(x, y, z) &
		\partial_{yz} \Gamma(x, y, z) \\
		\partial_{xz} \Gamma(x, y, z) & 
		\partial_{yz} \Gamma(x, y, z) &
		\partial_{zz} \Gamma(x, y, z)
	\end{bmatrix} \: ,
	\label{eq:M-matrix}
\end{equation}
with elements
$\partial_{\alpha\beta} \Gamma(x, y, z) \equiv 
\frac{\partial^{2} \Gamma(x, y, z)}{\partial \alpha \partial \beta}$, 
$\alpha, \beta = x, y, z$, representing the second derivatives of the harmonic
function
\begin{equation}
\Gamma(x, y, z) = \iiint\limits_{\upsilon} 
\frac{m(x^{\prime}, y^{\prime}, z^{\prime}) \: d\upsilon^{\prime}}
{\left[ (x-x^{\prime})^2 + (y-y^{\prime})^2 + (z-z^{\prime})^2 \right]^{\frac{1}{2}}} \: .
\label{eq:Gamma-volume-integral}
\end{equation}
In this equation, $x^{\prime}$, $y^{\prime}$ and $z^{\prime}$ are the coordinates 
of the volume element $d \upsilon^{\prime}$, which has total-magnetization intensity
$m(x^{\prime}, y^{\prime}, z^{\prime})$ (in $A/m$) and is located within the 
volume $\upsilon$ of the magnetic sources.
We consider that the total-magnetization intensity $m(x^{\prime}, y^{\prime}, z^{\prime})$
is strictly positive at all points within the magnetic sources. Consequently,
$\Gamma(x, y, z)$ is positive at all points located outside the magnetic sources.
From the mathematical point of view, $\mathbf{M}(x, y, z)$ (equation \ref{eq:M-matrix})
and $\Gamma(x, y, z)$ (equation \ref{eq:Gamma-volume-integral}) resemble, respectively, 
the gradient tensor and the corresponding gravitational potential that would be produced by 
the magnetic sources, at the point $(x, y, z)$, if they had a density distribution proportional 
to $m(x^{\prime}, y^{\prime}, z^{\prime})$.
Notice that $\mathbf{M}(x, y, z)$ is symmetric, its trace is identically zero at all points 
$(x, y, z)$ outside the magnetic sources and it has five independent components that are 
themselves harmonic functions \citep{pedersen_rasmussen1990}.
By exploring these properties, we can conveniently rewrite the 
total-field anomaly $\Delta T(x, y, z)$ (equation \ref{eq:tfanomaly}) as a linear combination 
of five independent harmonic functions as follows:
\begin{equation}
	\begin{split}
		\Delta T(x, y, z) = \:
		& a_{xx} \, \partial_{xx} \Gamma(x, y, z) + 
		a_{xy} \, \partial_{xy} \Gamma(x, y, z) + 
		a_{xz} \, \partial_{xz} \Gamma(x, y, z) + \\
		& a_{yy} \, \partial_{yy} \Gamma(x, y, z) + 
		a_{yz} \, \partial_{yz} \Gamma(x, y, z)
	\end{split} \quad ,
	\label{eq:tfanomaly-alternative}
\end{equation}
where
\begin{equation}
	\begin{split}
		a_{xx} &= m_{x} F_{x} - m_{z} F_{z} \\
		a_{xy} &= m_{x} F_{y} + m_{y} F_{x} \\
		a_{xz} &= m_{x} F_{z} + m_{z} F_{x} \\
		a_{yy} &= m_{y} F_{y} - m_{z} F_{z} \\
		a_{yz} &= m_{y} F_{z} + m_{z} F_{y}
	\end{split}
\label{eq:a-coefficients}
\end{equation}
are constants defined by the elements $F_{\alpha}$ and $m_{\beta}$, 
$\alpha = x, y, z$, $\beta = x, y, z$, 
of the vectors $\hat{\mathbf{F}}_{0}$ (equation \ref{eq:main_field}) and
$\hat{\mathbf{m}}(\mathbf{q})$ (equation \ref{eq:mag_vec}), respectively.
For simplicity, we have omitted the dependence on the 
parameters $I_{0}$ and $D_{0}$ (equation \ref{eq:main_field}) and 
$I$ and $D$ (equation \ref{eq:mag_vec}).

Let $\Delta \tilde{T}(x, y, z)$ be the total-field anomaly produced by a 
continuous layer of dipoles that have constant magnetization direction defined by
the unit vector $\hat{\mathbf{m}}(\mathbf{q})$ (equation \ref{eq:q_vector})
and are located at the constant depth $z_{c}$. The total-field anomaly produced
by this fictitious layer may be defined as
\begin{equation}
	\Delta \tilde{T}(x, y, z) = \gamma_{m} \, \hat{\mathbf{F}}_{0}^{\top} 
	\tilde{\mathbf{M}}(x, y, z) \: \hat{\mathbf{m}}(\mathbf{q}) \: ,
	\label{eq:tfanomaly-eqlayer}
\end{equation}
where $\tilde{\mathbf{M}}(x, y, z)$ is a matrix given by
\begin{equation}
	\tilde{\mathbf{M}}(x, y, z) = \begin{bmatrix}
		\partial_{xx} \Phi(x, y, z) & 
		\partial_{xy} \Phi(x, y, z) &
		\partial_{xz} \Phi(x, y, z) \\
		\partial_{xy} \Phi(x, y, z) & 
		\partial_{yy} \Phi(x, y, z) &
		\partial_{yz} \Phi(x, y, z) \\
		\partial_{xz} \Phi(x, y, z) & 
		\partial_{yz} \Phi(x, y, z) &
		\partial_{zz} \Phi(x, y, z)
	\end{bmatrix} \quad ,
	\label{eq:M-matrix-eqlayer}
\end{equation}
with elements
$\partial_{\alpha\beta} \Phi(x, y, z) \equiv 
\frac{\partial^{2} \Phi(x, y, z)}{\partial \alpha \partial \beta}$, 
$\alpha, \beta = x, y, z$, representing the second derivatives of the harmonic
function
\begin{equation}
	\Phi(x, y, z) = \int\limits_{-\infty}^{+\infty}\int\limits_{-\infty}^{+\infty}
	\frac{p(x'', y'', z_{c}) \: dS''}
	{\left[ (x-x'')^2 + (y-y'')^2 + (z-z_{c})^2 \right]^{\frac{1}{2}}} \: ,
	\quad z_{c} > z \: .
	\label{eq:Phi-surface-integral}
\end{equation}
In this equation, $x''$, $y''$ and $z_{c}$ are the coordinates 
of the area element $dS''$, which has magnetic moment per unit area
defined by the function $p(x'', y'', z_{c})$ (in $A$).
Notice that $\tilde{\mathbf{M}}(x, y, z)$ (equation \ref{eq:M-matrix-eqlayer}) also represents
a gradient tensor \citep{pedersen_rasmussen1990} and, consequently, it is symmetric, 
its trace is identically zero at all points $(x, y, z)$ above the layer (with $z < z_{c}$) 
and it has five independent components that are themselves harmonic functions.
These properties also permit rewrite $\Delta \tilde{T}(x, y, z)$ 
(equation \ref{eq:tfanomaly-eqlayer}) as a linear combination of independent
harmonic functions given by
\begin{equation}
	\begin{split}
		\Delta \tilde{T}(x, y, z) = \:
		& a_{xx} \, \partial_{xx} \Phi(x, y, z) + 
		a_{xy} \, \partial_{xy} \Phi(x, y, z) + 
		a_{xz} \, \partial_{xz} \Phi(x, y, z) + \\
		& a_{yy} \, \partial_{yy} \Phi(x, y, z) + 
		a_{yz} \, \partial_{yz} \Phi(x, y, z)
		\end{split} \quad ,
	\label{eq:tfanomaly-eqlayer-alternative}
\end{equation}
with coefficients $a_{\alpha\beta}$, $\alpha = x, y$, $\beta = x, y, z$, defined by
equation \ref{eq:a-coefficients}.

% Impose that the equivalent layer fit the total-field anomaly data
We know from potential theory that it is possible to find a function $p(x'', y'', z_{c})$
(equation \ref{eq:Phi-surface-integral}) so that the condition
$\Delta T(x, y, z) = \Delta \tilde{T}(x, y, z)$ holds true for all points $(x, y, z)$
located above the fictitious layer of dipoles. 
In this case, the layer is called \textit{equivalent layer}.
To investigate the properties of $p(x'', y'', z_{c})$, we must first 
observe that, by imposing the aforementioned condition and using equations \ref{eq:tfanomaly-alternative} and \ref{eq:tfanomaly-eqlayer-alternative}, we obtain
\begin{equation}
\begin{split}
a_{xx} \, &\left[\partial_{xx} \Phi(x, y, z) - \partial_{xx} \Gamma(x, y, z) \right] + \\
a_{xy} \, &\left[\partial_{xy} \Phi(x, y, z) - \partial_{xy} \Gamma(x, y, z) \right] + \\
a_{xz} \, &\left[\partial_{xz} \Phi(x, y, z) - \partial_{xz} \Gamma(x, y, z) \right] + \\
a_{yy} \, &\left[\partial_{yy} \Phi(x, y, z) - \partial_{yy} \Gamma(x, y, z) \right] + \\
a_{yz} \, &\left[\partial_{yz} \Phi(x, y, z) - \partial_{yz} \Gamma(x, y, z) \right] = 0
\: , \quad z < z_{c} \: ,
\end{split}
\label{eq:tfanomaly-alternative-equality}
\end{equation}
where the coefficients $a_{\alpha\beta}$ (equation \ref{eq:a-coefficients}), 
$\alpha = x, y$, $\beta = x, y, z$, are defined by arbitrary values of 
$I_{0}$ and $D_{0}$ (equation \ref{eq:main_field}) and 
$I$ and $D$ (equation \ref{eq:mag_vec}).
Because equation \ref{eq:tfanomaly-alternative-equality} is valid 
for any possible values of $a_{\alpha\beta}$, which are defined for any 
values of $I_{0}$, $D_{0}$, $I$ and $D$, the five linearly independent 
harmonic functions in brackets must be identically zero for all points 
$(x, y, z)$ above the equivalent layer, where $z < z_{c}$.
By equaling each independent function to zero and rewriting the 
second derivatives of the surface 
integral $\Phi(x, y, z)$ (equation \ref{eq:Phi-surface-integral}), we get
\begin{equation}
\partial_{\alpha\beta} \Gamma(x, y, z) = 
\int\limits_{-\infty}^{+\infty}\int\limits_{-\infty}^{+\infty}
p(x'', y'', z_{c}) \: \partial_{\alpha\beta} \frac{1}{r} \:\: dS'' \: ,
\quad z_{c} > z \: ,
\label{eq:D_alpha_beta_Gamma}
\end{equation}
where $(x'', y'', z_{c})$ is a point on the equivalent layer and 
$\partial_{\alpha\beta} \frac{1}{r} \equiv 
\frac{\partial^{2}}{\partial \alpha \partial \beta} \frac{1}{r}$ 
represents the second derivative,
with respect to $\alpha = x, y$ and $\beta = x, y, z$, of the inverse distance 
function
\begin{equation}
\frac{1}{r} \equiv 
\frac{1}{\left[ (x-x'')^2 + (y-y'')^2 + (z-z_{c})^2 \right]^{\frac{1}{2}}} \: .
\label{eq:inverse-distance}
\end{equation}
A possible solution for equation \ref{eq:D_alpha_beta_Gamma} can be obtained 
by properly deriving both sides of
\begin{equation}
\Gamma(x, y, z) = 
\int\limits_{-\infty}^{+\infty}\int\limits_{-\infty}^{+\infty}
p(x'', y'', z_{c}) \: \frac{1}{r} \:\: dS'' \: ,
\quad z_{c} > z \: .
\label{eq:Gamma_integral_equation}
\end{equation}
Notice that the function $p(x'', y'', z_{c})$ that solves this 
integral equation for $\Gamma(x, y, z)$ (equation \ref{eq:Gamma_integral_equation})
also solves the integral equations for the second derivatives 
$\partial_{\alpha\beta} \Gamma(x, y, z)$ (equation \ref{eq:D_alpha_beta_Gamma}). 
It can be shown (see Appendix A) that equation \ref{eq:Gamma_integral_equation} 
has a solution
\begin{equation}
p(x'', y'', z_{c}) = \frac{1}{2\pi} \partial_{z} \Gamma(x'', y'', z_{c}) \: ,
\label{eq:positivity_prop}
\end{equation}
where, according to equation \ref{eq:Gamma-volume-integral},
\begin{equation}
\partial_{z} \Gamma(x'', y'', z_{c}) = \iiint\limits_{\upsilon} 
\frac{m(x^{\prime}, y^{\prime}, z^{\prime}) (z^{\prime} - z_{c}) \: 
	d\upsilon^{\prime}}
{\left[ (x''-x^{\prime})^2 + (y''-y^{\prime})^2 + (z_{c}-z^{\prime})^2 \right]^{\frac{3}{2}}} \: , \quad z^{\prime} > z_{c} \: .
\label{eq:DzGamma-volume-integral}
\end{equation}
From the physical point of view, equation \ref{eq:DzGamma-volume-integral} 
represents the vertical component of the gravitational attraction 
(or the pseudogravity anomaly) that would be produced by the magnetic sources,
on the equivalent layer, if they had a density distribution proportional to 
$m(x^{\prime}, y^{\prime}, z^{\prime})$.
Since $m(x^{\prime}, y^{\prime}, z^{\prime})$ is strictly positive
at all points $(x^{\prime}, y^{\prime}, z^{\prime})$ within the magnetic sources,
$\partial_{z} \Gamma(x'', y'', z_{c})$ is positive at all points 
$(x'', y'', z_{c})$ located on the equivalent layer.

The most interesting aspect of magnetic-moment distribution $p(x'', y'', z_{c})$
(equation \ref{eq:positivity_prop}) is that it is defined as the product of a
positive constant $\frac{1}{2\pi}$ and the 
function $\partial_{z} \Gamma(x'',y'',z_{c})$, which is strictly  
positive at all points $(x'',y'',z_{c})$ on the equivalent layer. 
Hence, $p(x'', y'', z_{c})$ is strictly positive at all points on the
equivalent layer as well.
This relation is similar to that presented by \cite{pedersen1991} and 
\cite{li_etal_2014}. They determined, in the wavenumber domain, the 
magnetic-moment distribution within a continuous equivalent layer 
vertically magnetized by induction. 
They also considered a planar equivalent layer located below and parallel to a 
horizontal plane containing the observed total-field anomaly data. 
Under these assumptions, \cite{pedersen1991} and \cite{li_etal_2014} 
concluded that the magnetic-moment distribution within the continuous equivalent 
layer is all positive and proportional to the pseudogravity anomaly produced by 
the source on the plane of the equivalent layer.
Here, we do not follow the same wavenumber-domain 
reasoning used by those authors. Moreover, equation \ref{eq:positivity_prop} 
generalizes this positivity condition because (1) it holds true for all cases 
in which the magnetization of the equivalent layer has the same direction as 
the true total-magnetization of the sources, whether it is purely induced or not 
and (2) it does not require that the observed total-field anomaly data be on 
a plane. 


%% Discretizing layer
\subsection{Parametrization and forward problem}

In practical situations, it is not possible to determine a continuous magnetic-moment
distribution $p(x'',y'',z_{c})$ (equation \ref{eq:positivity_prop}) over the 
equivalent layer. 
For this reason, the layer has to be approximated by a discrete set of dipoles 
(the equivalent sources) with unit volume located at the constant depth $z = z_c$.
The total-field anomaly produced by this discrete layer (the predicted total-field anomaly) 
at a given point $(x_{i}, y_{i}, z_{i})$, $i = 1, \dots, N$, is given by
\begin{equation}
\Delta T_{i}(\mathbf{s}) = \mathbf{g}_{i}(\mathbf{q})^{\top} \mathbf{p},
\label{eq:tfa_pred_i}
\end{equation}
where $\mathbf{s}$ is an $(M + 2) \times 1$ partitioned vector (the parameter vector) given by 
\begin{equation}
	\mathbf{s} = \begin{bmatrix}
		\mathbf{p} \\
		\mathbf{q}
	\end{bmatrix} \: ,
	\label{eq:parameter-vector}
\end{equation}
$\mathbf{q}$ is the magnetization direction vector (equation \ref{eq:q_vector}), $\mathbf{p}$ is an 
$M \times 1$ vector (the magnetic-moment vector) whose $j$th element, $j = 1, \dots, M$, is the 
magnetic moment intensity $p_{j}$ (in $A \, m^{2}$) of the $j$th dipole and 
$\mathbf{g}_{i} (\mathbf{q})$ is another $M \times 1$ vector whose $j$th element is defined 
by the harmonic function
\begin{equation}
g_{ij} (\mathbf{q})  = \gamma_m \hat{\mathbf{F}}_{0}^T \, 
\mathbf{M}_{ij} \, \hat{\mathbf{m}}(\mathbf{q}) \: .
\label{eq:g_ij}
\end{equation}
In this equation, $\mathbf{M}_{ij}$ is a $3 \times 3$ matrix given by
\begin{equation}
\mathbf{M}_{ij} = \begin{bmatrix}
\partial_{xx} \frac{1}{r} & 
\partial_{xy} \frac{1}{r} &
\partial_{xz} \frac{1}{r} \\
\partial_{xy} \frac{1}{r} & 
\partial_{yy} \frac{1}{r} &
\partial_{yz} \frac{1}{r} \\
\partial_{xz} \frac{1}{r} & 
\partial_{yz} \frac{1}{r} &
\partial_{zz} \frac{1}{r}
\end{bmatrix} \quad ,
\label{eq:Mij-matrix}
\end{equation}
where $\partial_{\alpha\beta} \frac{1}{r} \equiv 
\frac{\partial^{2}}{\partial \alpha \partial \beta} \frac{1}{r}$ 
represent the second derivatives,
with respect to $\alpha = x, y, z$ and $\beta = x, y, z$, of the inverse distance 
$\frac{1}{r}$ (equation \ref{eq:inverse-distance}) between the coordinates of the 
observation points $(x, y, z) = (x_{i}, y_{i}, z_{i})$ and the coordinates of the 
equivalent sources $(x'', y'', z_{c}) = (x_{j}, y_{j}, z_{c})$.
Equations $\ref{eq:tfa_pred_i}$-$\ref{eq:Mij-matrix}$ show that the predicted total-field anomaly 
$\Delta T_{i}(\mathbf{s})$ has a linear relation with the magnetic-moment vector $\mathbf{p}$ 
and a nonlinear relation with the magnetization direction vector $\mathbf{q}$ 
(equation \ref{eq:q_vector}).


\subsection{Inverse problem}

%%%% Defining the objective function
Let $\mathbf{\Delta T}^{o}$ be the observed-data vector whose $i$th element $\Delta T_{i}^{o}$
is the observed total-field anomaly produced by the magnetic sources at the point 
$(x_{i},y_{i},z_{i})$, $i = 1, \dots, N$. 
Similarly, let $\mathbf{\Delta T} (\mathbf{s})$ be the predicted-data vector whose $i$th element 
$\Delta T_{i}(\mathbf{s})$ (equation \ref{eq:tfa_pred_i}) is the predicted total-field anomaly  
produced by the discrete equivalent layer at the same point $(x_{i},y_{i},z_{i})$. 
In order to estimate the parameter vector $\mathbf{s}$ (equation \ref{eq:parameter-vector})
minimizing the difference between $\mathbf{\Delta T}^{o}$ and 
$\mathbf{\Delta T}(\mathbf{s})$, we solve the following inverse problem:
\begin{subequations}
	\begin{align}
	& \text{minimizing}
	& &\Psi(\mathbf{s}) =\lVert \mathbf{\Delta T}^{o} - \mathbf{\Delta T} (\mathbf{s}) 
	\rVert_{2}^{2} + \, \mu f_0 \parallel \mathbf{p} \parallel_{2}^{2} \: , \\
	& \text{subject to}
	& & \mathbf{p} \geqslant \mathbf{0} \: .
	\end{align}
	\label{eq:positivity_goal_function}
\end{subequations}
On the right side of equation \ref{eq:positivity_goal_function}a, the first 
and second terms are 
the data-misfit function and the zeroth-order Tikhonov regularization 
function, $\mu$ is the regularizing parameter, $\| \cdot \|_{2}^{2}$ represents 
the squared Euclidean norm and $f_0$. This factor makes a trade-off 
between the data-misfit and zeroth-order Tikhonov regularization functions.
In the inequality \ref{eq:positivity_goal_function}b, $\mathbf{0}$ is an 
$M \times 1$ vector with all elements equal to zero and the inequality sign 
is applied element 
by element. This positivity constraint on the magnetic-moment vector $\mathbf{p}$ 
is incorporated by using the nonnegative least squares (NNLS) proposed by 
\cite{lawson_hanson_1974}. 

%% Deducing the equations
To solve this constrained inverse problem, let us first consider the following 
second-order expansion of the goal function (equation \ref{eq:positivity_goal_function}a)
around $\mathbf{s} = \mathbf{s}^{k}$ (equation \ref{eq:parameter-vector}):
\begin{equation}
\Psi(\mathbf{s}^{k} + \mathbf{\Delta s}^{k}) \approx \Psi(\mathbf{s}^{k}) + 
{\mathbf{J}^{k}}^{\top} \mathbf{\Delta s}^{k} + 
\frac{1}{2} {\mathbf{\Delta s}^{k}}^{\top} \mathbf{H}^{k} \mathbf{\Delta s}^{k}  \: ,
\label{eq:sec_ord_goal}
\end{equation}
where $\mathbf{\Delta s}^{k}$ is a perturbation on the parameter vector 
and the terms $\mathbf{J}^{k}$ and $\mathbf{H}^{k}$ are, respectively, the gradient vector 
and the Hessian matrix evaluated at $\mathbf{s}^{k}$.
Then, we estimate the perturbation vector $\bar{\mathbf{\Delta s}}^k$ that minimizes the 
expanded function (equation \ref{eq:sec_ord_goal}) by taking the gradient with respect 
to $\mathbf{\Delta s}^k$ and setting the result equal to the null vector.
This procedure leads to the linear system
\begin{equation}
\mathbf{H}^{k} \bar{\mathbf{\Delta s}}^{k} = - \mathbf{J}^{k} \: ,
\label{eq:linear_sys_GN}
\end{equation}
which represents the $k$th step of the Gauss-Newton method \citep{aster2005} for minimizing 
our goal function (equation \ref{eq:positivity_goal_function}a).
We rewrite this linear system by neglecting the cross-derivatives in the Hessian matrix 
as follows:
\begin{equation}
\left[
\begin{array}{c|c}
\mathbf{H}_{pp}^{k} & \mathbf{0} \\
\hline
\mathbf{0}^{\top} & \mathbf{H}_{qq}^{k}
\end{array}
\right] \left[ \begin{array}{c}
\bar{\mathbf{\Delta p}}^{k} \\ 
\bar{\mathbf{\Delta q}}^{k} 
\end{array} \right] \approx -\left[ \begin{array}{c}
\mathbf{J}_{p}^{k} \\ 
\mathbf{J}_{q}^{k} 
\end{array} \right] ,
\label{eq:linear_sys_GN_block}
\end{equation}
in which $\mathbf{0}$ is an $M \times 2$ matrix containing all elements equal to zero, 
$\bar{\mathbf{\Delta p}}^{k} = \bar{\mathbf{p}}^{k+1} - \bar{\mathbf{p}}^{k}$ 
is a correction on the magnetic-moment vector $\mathbf{p}$,
$\bar{\mathbf{\Delta q}}^{k} = \bar{\mathbf{q}}^{k+1} - \bar{\mathbf{q}}^{k}$ 
is a correction on the magnetization direction $\mathbf{q}$ and the terms 
$\mathbf{J}_{\alpha}^{k}$ and $\mathbf{H}_{\alpha \alpha}^{k}$, $\alpha = p,q$, 
are the gradient vector and the Hessian matrix calculated with respect to the elements of 
$\mathbf{p}$ and $\mathbf{q}$, respectively. 
The gradient vector $\mathbf{J}_{p}^{k}$ and the Hessian matrix $\mathbf{H}_{pp}^{k}$ 
(equation \ref{eq:linear_sys_GN_block}) related to the magnetic-moment vector 
$\mathbf{p}$ (equation \ref{eq:parameter-vector}) are, respectively,
\begin{equation}
\mathbf{J}_{p}^{k} = -2 {\mathbf{G}_{p}^{k}}^{\top} 
\left[ \mathbf{\Delta T}^{o} - \mathbf{\Delta T} (\bar{\mathbf{s}}^{k}) \right] + 
2\mu f_{0}^{k} \bar{\mathbf{p}}^{k} 
\label{eq:grad_p}
\end{equation}   
and   
\begin{equation}
\mathbf{H}_{pp}^{k} = 2 {\mathbf{G}_{p}^{k}}^{\top} \mathbf{G}_{p}^{k} + 
2 \mu f_{0}^{k} \mathbf{I} \: ,
\label{eq:hess_p}
\end{equation}
where $\mathbf{G}_p^{k}$ is an $N \times M$ matrix whose $ij$th element is given by the harmonic 
function $g_{ij}(\bar{\mathbf{q}}^{k})$ (equation \ref{eq:g_ij}) evaluated at the 
magnetization direction $\bar{\mathbf{q}}^{k}$, $\mathbf{I}$ is the $M \times M$ identity matrix and 
$f_{0}^{k}$ is a  normalizing factor equal to
\begin{equation}
f_{0}^{k} = \dfrac{trace \left({\mathbf{G}_{p}^{k}}^{\top} \mathbf{G}_{p}^{k} \right)}{M} \, .
\label{eq:norm_factor}
\end{equation}
This factor is used with the purpose of making a trade-off between the terms 
forming the gradient vector $\mathbf{J}_{p}^{k}$ (equation \ref{eq:grad_p}) and 
the Hessian matrix $\mathbf{H}_{pp}^{k}$ (equation \ref{eq:hess_p}) 
along the iterative process. The gradient vector $\mathbf{J}_{q}^{k}$ and 
the Hessian matrix $\mathbf{H}_{qq}^{k}$ 
(equation \ref{eq:linear_sys_GN_block}) related to the magnetization direction 
$\mathbf{q}$ (equation \ref{eq:q_vector}) are, respectively,
\begin{equation}
\mathbf{J}_{q}^{k} = -2 {\mathbf{G}_{q}^{k}}^{\top} 
\left[ \mathbf{\Delta T}^{o} - \mathbf{\Delta T} (\bar{\mathbf{s}}^{k}) \right]
\label{eq:grad_q}
\end{equation}   
and   
\begin{equation}
\mathbf{H}_{qq}^{k} \approx 2 {\mathbf{G}_{q}^{k}}{^\top} \mathbf{G}_{q}^{k} \: ,
\label{eq:hess_q}
\end{equation}
in which $\mathbf{G}_{q}^{k}$ is a $N \times 2$ matrix given by 
\begin{equation}
\mathbf{G}_{q}^{k} = \begin{bmatrix}
\partial_{I} \mathbf{g}_{1}(\bar{\mathbf{q}}^{k})^{\top} \bar{\mathbf{p}}^{k} & 
\partial_{D} \mathbf{g}_{1}(\bar{\mathbf{q}}^{k})^{\top} \bar{\mathbf{p}}^{k} \\
\vdots & \vdots  \\
\partial_{I} \mathbf{g}_{N}(\bar{\mathbf{q}}^{k})^{\top} \bar{\mathbf{p}}^{k} & 
\partial_{D} \mathbf{g}_{N}(\bar{\mathbf{q}}^{k})^{\top} \bar{\mathbf{p}}^{k} 
\end{bmatrix} \: ,
\label{eq:Gq}
\end{equation}
where 
$\partial_{\alpha} \mathbf{g}_{i}(\bar{\mathbf{q}}^{k}) \equiv 
\frac{\partial \mathbf{g}_{i}(\bar{\mathbf{q}}^{k})}{\partial \alpha}$, $\alpha= I, D$, 
represent the first derivatives of vector 
$\mathbf{g}_{i}(\bar{\mathbf{q}}^{k})$ (equation \ref{eq:tfa_pred_i}) with respect to the 
inclination $I$ and the declination $D$ of the total magnetization of the sources.

\subsection{Iterative algorithm for solving the inverse problem}

The iteration $k = 0$ of our algorithm starts with an initial guess 
$\bar{\mathbf{q}}^{k} = \bar{\mathbf{q}}^{0}$ for the direction vector $\mathbf{q}$ 
(equation \ref{eq:q_vector}).
By using this $\bar{\mathbf{q}}^{k}$, the upper part of equation 
\ref{eq:linear_sys_GN_block} leads to the following linear system for the magnetic-moment 
vector:
\begin{equation}
\left[ {\mathbf{G}_{p}^{k}}^{\top} \mathbf{G}_{p}^{k} + 
\mu f_{0}^{k} \mathbf{I} \right] \bar{\mathbf{p}}^{k} = {\mathbf{G}_{p}^{k}}^{\top} \mathbf{\Delta T}^{o} \: .
\label{eq:linear_sys_p}
\end{equation}
To impose the positivity constraint (equation \ref{eq:positivity_goal_function}b) on the 
magnetic-moment distribution $\bar{\mathbf{p}}^{k+1}$ within the equivalent layer, 
we solve this linear system (equation \ref{eq:linear_sys_p}) by using the nonnegative least 
squares (NNLS) method \citep{lawson_hanson_1974, silvadias_etal_2007}.
This positive magnetic-moment distribution is then used to estimate a correction 
$\bar{\mathbf{\Delta q}}^{k}$ on the magnetization direction by solving the following 
unconstrained nonlinear system via Levenberg-Marquardt method \citep{aster2005}:
\begin{equation}
\left[ {\mathbf{G}_{q}^{k}}^{\top} \mathbf{G}_{q}^{k} + \lambda \, \mathbf{I} \right] 
\bar{\mathbf{\Delta q}}^{k} = {\mathbf{G}_{q}^{k}}^{\top} 
\left[ \mathbf{\Delta T}^{o} - \mathbf{\Delta T} (\mathbf{s}^{k}) \right] \: ,
\label{eq:linear_sys_q}
\end{equation}
where $\lambda$ is the Marquardt parameter and $\mathbf{I}$ is the identity matrix. 
After estimating the correction $\bar{\mathbf{\Delta q}}^{k}$ 
at the $k$th iteration, we update the magnetization direction as follows
\begin{equation}
\bar{\mathbf{q}}^{k+1} = \bar{\mathbf{q}}^{k} + \bar{\mathbf{\Delta q}}^{k} \: ,
\label{eq:q_next}
\end{equation}
use it as input for estimating a new positive magnetic-moment distribution 
with equation \ref{eq:linear_sys_p} and so on.
The iterative process stops when the goal function (equation \ref{eq:positivity_goal_function}a) 
is invariant along successive iterations. 
We show in Appendix B that our method fails if the sources are vertically magnetized.

\subsection{The choice of layer depth $\mathbf{z_{c}}$ and regularization parameter $\mathbf{\mu}$}

The procedure for the use of our methodology for estimating the total magnetization 
require the choice of two main parameters. The first one is the layer depth $z_c$ 
(Figure \ref{fig:eqlayer_figure}) and the second is the regularization parameter 
$\mu$ (equation \ref{eq:linear_sys_p}).

There is a classical criterion proposed by \cite{dampney1969} to define the layer 
depth based on the horizontal data spacing. This criterion states that the 
distance between the plane containing the data and the  
plane defining the layer should vary from $2.5$ to $6$ times the horizontal 
data spacing. This criterion, however, is valid for evenly spaced data. 
Here, we define the layer depth $z_c$ by using the horizontal space between 
adjacent flight lines of an airborne survey. We found empirically that $z_c$ 
can vary from $2$ to $3$ times the spacing between adjacent flight lines.
Notice that the range we found empirically is smaller than that proposed by 
Dampney. Apparently, this is due to the fact that, in an airborne survey, 
the data spacing along lines is smaller than the space between lines.

To solve the equation \ref{eq:linear_sys_p} we have to choose a reliable regularization parameter $\mu$. For this purpose, we use the L-curve method \citep{hansen1992}. This approach is widely used in the literature to find a regularizing parameter, which filtering out enough noise without loosing too much information in the final solution. The procedure of finding the parameter plot a curve of optimal values between the solution norm and residual norm. The corner of the curve is the optimal regularization parameter which gives a threshold between the regularizing function and the data misfit.

\section{Methodology}
\label{sec:methodology}

\subsection{Fundamentals of magnetic equivalent layer and the positive magnetic-moment distribution}
\label{subsec:mag_eqlayer}

Let $\Delta T(x, y, z)$ be the total-field anomaly produced by a set of magnetic
sources at a point $(x, y, z)$ referred to a topocentric Cartesian coordinate system 
with $x$-, $y$- and $z$-axis being oriented to north, east and down, respectively.
Consider that the main geomagnetic field has a constant inclination $I_{0}$ and declination
$D_{0}$ throughout the study area, so that its direction can be defined by the unit vector
\begin{equation}
\hat{\mathbf{F}}_{0} = \begin{bmatrix}
\cos I_{0} \cos D_{0} \\
\cos I_{0} \sin D_{0} \\
\sin I_{0}
\end{bmatrix} \: .
\label{eq:main_field}
\end{equation}
Additionally, consider that the magnetic sources have a constant total magnetization 
direction defined by the unit vector
\begin{equation}
\hat{\mathbf{m}}(\mathbf{q}) = \begin{bmatrix}
\cos {I} \cos {D} \\
\cos {I} \sin {D} \\
\sin {I}
\end{bmatrix} \: ,
\label{eq:mag_vec}
\end{equation}
where the constants $I$ and $D$ represent its inclination and declination, respectively,
and $\mathbf{q}$ is a $2 \times 1$ vector given by:
\begin{equation}
\mathbf{q} = \begin{bmatrix}
I \\ 
D
\end{bmatrix} \: .
\label{eq:q_vector}
\end{equation}
In this case, the total-field anomaly $\Delta T(x, y, z)$ can be written as follows:
\begin{equation}
\Delta T(x, y, z) = \gamma_{m} \, \hat{\mathbf{F}}_{0}^{\top} \mathbf{M}(x, y, z) \: 
\hat{\mathbf{m}}(\mathbf{q}) \: ,
\label{eq:tfanomaly}
\end{equation}
where $\gamma_{m} = 10^{-9} \frac{\mu_{0}}{4 \pi}$ (in $n \, H / m $), 
$\mu_{0}$ is the vacuum magnetic permeability and $\mathbf{M}(x, y, z)$ is a matrix 
given by
\begin{equation}
	\mathbf{M}(x, y, z) = \begin{bmatrix}
		\partial_{xx} \Gamma(x, y, z) & 
		\partial_{xy} \Gamma(x, y, z) &
		\partial_{xz} \Gamma(x, y, z) \\
		\partial_{xy} \Gamma(x, y, z) & 
		\partial_{yy} \Gamma(x, y, z) &
		\partial_{yz} \Gamma(x, y, z) \\
		\partial_{xz} \Gamma(x, y, z) & 
		\partial_{yz} \Gamma(x, y, z) &
		\partial_{zz} \Gamma(x, y, z)
	\end{bmatrix} \: ,
	\label{eq:M-matrix}
\end{equation}
with elements
$\partial_{\alpha\beta} \Gamma(x, y, z) \equiv 
\frac{\partial^{2} \Gamma(x, y, z)}{\partial \alpha \partial \beta}$, 
$\alpha, \beta = x, y, z$, representing the second derivatives of the harmonic
function
\begin{equation}
\Gamma(x, y, z) = \iiint\limits_{\upsilon} 
\frac{m(x^{\prime}, y^{\prime}, z^{\prime}) \: d\upsilon^{\prime}}
{\left[ (x-x^{\prime})^2 + (y-y^{\prime})^2 + (z-z^{\prime})^2 \right]^{\frac{1}{2}}} \: .
\label{eq:Gamma-volume-integral}
\end{equation}
In this equation, $x^{\prime}$, $y^{\prime}$ and $z^{\prime}$ are the coordinates 
of the volume element $d \upsilon^{\prime}$, which has total-magnetization intensity
$m(x^{\prime}, y^{\prime}, z^{\prime})$ (in $A/m$) and is located within the 
volume $\upsilon$ of the magnetic sources.
We consider that total-magnetization intensity $m(x^{\prime}, y^{\prime}, z^{\prime})$
is strictly positive at all points within the magnetic sources. Consequently,
$\Gamma(x, y, z)$ is positive at all points located outside the magnetic sources.
From the physical point of view, $\mathbf{M}(x, y, z)$ (equation \ref{eq:M-matrix})
and $\Gamma(x, y, z)$ (equation \ref{eq:Gamma-volume-integral}) represent, respectively, 
the gradient tensor and the corresponding gravitational potential that would be produced by 
the magnetic sources, at the point $(x, y, z)$, if they had a density distribution proportional 
to $m(x^{\prime}, y^{\prime}, z^{\prime})$.
Notice that $\mathbf{M}(x, y, z)$ is symmetric, its trace is identically zero at all points 
$(x, y, z)$ outside the magnetic sources and it has five independent components that are 
themselves harmonic functions \citep{pedersen_rasmussen1990}.
By exploring these properties, we can conveniently rewrite the 
total-field anomaly $\Delta T(x, y, z)$ (equation \ref{eq:tfanomaly}) as a linear combination 
of five independent harmonic functions as follows:
\begin{equation}
\begin{split}
\Delta T(x, y, z) = 
&a_{xx} \, \partial_{xx} \Gamma(x, y, z) + 
a_{xy} \, \partial_{xy} \Gamma(x, y, z) + 
a_{xz} \, \partial_{xz} \Gamma(x, y, z) + \\
&a_{yy} \, \partial_{yy} \Gamma(x, y, z) + 
a_{yz} \, \partial_{yz} \Gamma(x, y, z)
\end{split}
\label{eq:tfanomaly-alternative}
\end{equation}
where
\begin{equation}
\begin{split}
a_{xx} &= m_{x} F_{x} - m_{z} F_{z} \\
a_{xy} &= m_{x} F_{y} + m_{y} F_{x} \\
a_{xz} &= m_{x} F_{z} + m_{z} F_{x} \\
a_{yy} &= m_{y} F_{y} - m_{z} F_{z} \\
a_{yz} &= m_{y} F_{z} + m_{z} F_{y}
\end{split}
\label{eq:a-coefficients}
\end{equation}
are constants defined by the elements $F_{\alpha}$ and $m_{\beta}$, 
$\alpha = x, y, z$, $\beta = x, y, z$, 
of the vectors $\hat{\mathbf{F}}_{0}$ (equation \ref{eq:main_field}) and
$\hat{\mathbf{m}}(\mathbf{q})$ (equation \ref{eq:mag_vec}), respectively.
For simplicity, we have omitted the dependence on the 
parameters $I_{0}$ and $D_{0}$ (equation \ref{eq:main_field}) and 
$I$ and $D$ (equation \ref{eq:mag_vec}).

Let $\Delta \tilde{T}(x, y, z)$ be the total-field anomaly produced by a 
continuous layer of dipoles that have constant magnetization direction defined by
the unit vector $\hat{\mathbf{m}}(\mathbf{q})$ (equation \ref{eq:q_vector})
and are located at the constant depth $z_{c}$. The total-field anomaly produced
by this fictitious layer may be defined as
\begin{equation}
\Delta \tilde{T}(x, y, z) = \gamma_{m} \, \hat{\mathbf{F}}_{0}^{\top} \mathbf{H}(x, y, z) \: 
\hat{\mathbf{m}}(\mathbf{q}) \: ,
\label{eq:tfanomaly-eqlayer}
\end{equation}
where $\mathbf{H}(x, y, z)$ is a matrix given by
\begin{equation}
	\mathbf{H}(x, y, z) = \begin{bmatrix}
		\partial_{xx} \Phi(x, y, z) & 
		\partial_{xy} \Phi(x, y, z) &
		\partial_{xz} \Phi(x, y, z) \\
		\partial_{xy} \Phi(x, y, z) & 
		\partial_{yy} \Phi(x, y, z) &
		\partial_{yz} \Phi(x, y, z) \\
		\partial_{xz} \Phi(x, y, z) & 
		\partial_{yz} \Phi(x, y, z) &
		\partial_{zz} \Phi(x, y, z)
	\end{bmatrix} \quad ,
	\label{eq:H-matrix}
\end{equation}
with elements
$\partial_{\alpha\beta} \Phi(x, y, z) \equiv 
\frac{\partial^{2} \Phi(x, y, z)}{\partial \alpha \partial \beta}$, 
$\alpha, \beta = x, y, z$, representing the second derivatives of the harmonic
function
\begin{equation}
	\Phi(x, y, z) = \int\limits_{-\infty}^{+\infty}\int\limits_{-\infty}^{+\infty}
	\frac{p(x'', y'', z_{c}) \: dS''}
	{\left[ (x-x'')^2 + (y-y'')^2 + (z-z_{c})^2 \right]^{\frac{1}{2}}} \: ,
	\quad z_{c} > z \: .
	\label{eq:Phi-surface-integral}
\end{equation}
In this equation, $x''$, $y''$ and $z_{c}$ are the coordinates 
of the area element $dS''$, which has magnetic moment per unit area
defined by the function $p(x'', y'', z_{c})$ (in $A$).
Notice that $\mathbf{H}(x, y, z)$ (equation \ref{eq:H-matrix}) also represents
a gradient tensor \citep{pedersen_rasmussen1990} and, consequently, it is symmetric, 
its trace is identically zero at all points $(x, y, z)$ above the layer (with $z < z_{c}$) 
and it has five independent components that are themselves harmonic functions.
These properties also permit rewrite $\Delta \tilde{T}(x, y, z)$ 
(equation \ref{eq:tfanomaly-eqlayer}) as a linear combination of independent
harmonic functions given by
\begin{equation}
\begin{split}
\Delta \tilde{T}(x, y, z) = 
&a_{xx} \, \partial_{xx} \Phi(x, y, z) + 
a_{xy} \, \partial_{xy} \Phi(x, y, z) + 
a_{xz} \, \partial_{xz} \Phi(x, y, z) + \\
&a_{yy} \, \partial_{yy} \Phi(x, y, z) + 
a_{yz} \, \partial_{yz} \Phi(x, y, z)
\end{split} \: ,
\label{eq:tfanomaly-eqlayer-alternative}
\end{equation}
with coefficients $a_{\alpha\beta}$, $\alpha = x, y$, $\beta = x, y, z$, defined by
equation \ref{eq:a-coefficients}.

% Impose that the equivalent layer fit the total-field anomaly data
We know from potential theory that it is possible to find a function $p(x'', y'', z_{c})$
(equation \ref{eq:Phi-surface-integral}) so that the condition
$\Delta T(x, y, z) = \Delta \tilde{T}(x, y, z)$ holds true for all points $(x, y, z)$
located above the fictitious layer of dipoles. 
In this case, the layer is called \textit{equivalent layer}.
To investigate the properties of function $p(x'', y'', z_{c})$, we must first 
observe that, by imposing the condition stated right above and using equations \ref{eq:tfanomaly-alternative} and \ref{eq:tfanomaly-eqlayer-alternative}, we obtain
\begin{equation}
\begin{split}
a_{xx} \, &\left[\partial_{xx} \Phi(x, y, z) - \partial_{xx} \Gamma(x, y, z) \right] + \\
a_{xy} \, &\left[\partial_{xy} \Phi(x, y, z) - \partial_{xy} \Gamma(x, y, z) \right] + \\
a_{xz} \, &\left[\partial_{xz} \Phi(x, y, z) - \partial_{xz} \Gamma(x, y, z) \right] + \\
a_{yy} \, &\left[\partial_{yy} \Phi(x, y, z) - \partial_{yy} \Gamma(x, y, z) \right] + \\
a_{yz} \, &\left[\partial_{yz} \Phi(x, y, z) - \partial_{yz} \Gamma(x, y, z) \right] = 0
\: , \quad z < z_{c} \: ,
\end{split}
\label{eq:tfanomaly-alternative-equality}
\end{equation}
where the coefficients $a_{\alpha\beta}$ (equation \ref{eq:a-coefficients}), 
$\alpha = x, y, z$, $\beta = x, y, z$, are defined by arbitrary values of 
$I_{0}$ and $D_{0}$ (equation \ref{eq:main_field}) and 
$I$ and $D$ (equation \ref{eq:mag_vec}).
By noting that equation \ref{eq:tfanomaly-alternative-equality} represents a linear 
combination of independent harmonic functions, we conclude that the five terms
in brackets must be identically zero for all points $(x, y, z)$ above the equivalent 
layer, where $z < z_{c}$. 
Each term can be conveniently written in terms of the second derivative of the surface 
integral $\Phi(x, y, z)$ (equation \ref{eq:Phi-surface-integral}), so that
\begin{equation}
	\partial_{\alpha\beta} \Gamma(x, y, z) = 
	\int\limits_{-\infty}^{+\infty}\int\limits_{-\infty}^{+\infty}
	p(x'', y'', z_{c}) \: \partial_{\alpha\beta} \frac{1}{r} \:\: dS'' \: ,
	\quad z_{c} > z \: ,
	\label{eq:D_alpha_beta_Gamma}
\end{equation}
where $\partial_{\alpha\beta} \frac{1}{r}$ represents the second derivative,
with respect to $\alpha = x, y, z$ and $\beta = x, y, z$, of the inverse distance 
function
\begin{equation}
	\frac{1}{r} \equiv 
	\frac{1}{\left[ (x-x'')^2 + (y-y'')^2 + (z-z_{c})^2 \right]^{\frac{1}{2}}} \: .
	\label{eq:inverse-distance}
\end{equation}
Note that equation \ref{eq:D_alpha_beta_Gamma} is obtained by properly deriving both sides of
\begin{equation}
\Gamma(x, y, z) = 
\int\limits_{-\infty}^{+\infty}\int\limits_{-\infty}^{+\infty}
p(x'', y'', z_{c}) \: \frac{1}{r} \:\: dS'' \: ,
\quad z_{c} > z \: .
\label{eq:D_Gamma}
\end{equation}
It can be shown (see Appendix A) that 
\begin{equation}
p(x'', y'', z_{c}) = \frac{1}{2\pi} \partial_{z} \Gamma(x'', y'', z_{c})
\label{eq:positivity_prop}
\end{equation}
where, according to equation \ref{eq:Gamma-volume-integral},
\begin{equation}
\partial_{z} \Gamma(x'', y'', z_{c}) = \iiint\limits_{\upsilon} 
\frac{m(x^{\prime}, y^{\prime}, z^{\prime}) (z^{\prime} - z_{c}) \: 
d\upsilon^{\prime}}
{\left[ (x''-x^{\prime})^2 + (y''-y^{\prime})^2 + (z_{c}-z^{\prime})^2 \right]^{\frac{3}{2}}} \: , \quad z^{\prime} > z_{c} \: .
\label{eq:DzGamma-volume-integral}
\end{equation}
From the physical point of view, equation \ref{eq:DzGamma-volume-integral} 
represents the vertical component
of the gravitational attraction that would be produced by the magnetic sources 
if they have a density distribution proportional to 
$m(x^{\prime}, y^{\prime}, z^{\prime})$. 
Since $m(x^{\prime}, y^{\prime}, z^{\prime})$ is strictly positive
at all points $(x^{\prime}, y^{\prime}, z^{\prime})$ within the magnetic sources,
$\partial_{z} \Gamma(x'', y'', z_{c})$ is positive at all points 
$(x'', y'', z_{c})$ located on the equivalent layer.

The most interesting aspect of equation \ref{eq:positivity_prop} is that the 
magnetic-moment distribution $p(x'', y'', z_{c})$ is defined as the product of a
positive constant $\frac{1}{2\pi}$ and the 
function $\partial_{z} \Gamma(x'',y'',z_{c})$, which is all 
positive at all points $(x'',y'',z_{c})$ over the equivalent layer. 
This relation is similar to that presented by \cite{pedersen1991} and 
\cite{li_etal_2014}. They determined, in the wavenumber domain, the 
magnetic-moment distribution within a continuous equivalent layer with the same
magnetization direction as the local-main field at the pole. 
They also considered a planar equivalent layer located below and parallel to a 
horizontal plane containing the observed total-field anomaly data. 
Additionally, they assume that the magnetic sources have a purely induced 
magnetization. Under these assumptions, \cite{pedersen1991} and \cite{li_etal_2014} 
concluded that the magnetic-moment distribution within the continuous equivalent layer 
is proportional to the pseudogravity anomaly produced by the source on the plane of 
the equivalent layer. 
By following different approaches using magnetic microscopy data, 
\cite{baratchart2013} and \cite{lima_weiss_2016} pointed out that, by imposing a 
positivity constraint, the solution to the inverse problem is a unique 
magnetic-moment distribution. Here, we do not follow the same wavenumber-domain 
reasoning used by all these authors. Moreover, equation \ref{eq:positivity_prop} 
generalizes this positivity condition because (1) it holds true for all cases in which 
the magnetization of the equivalent layer has the same direction as the true 
magnetization of the sources, whether it is purely induced or not, (2) does not 
require that the observed total-field anomaly data be on a plane. 



%% Discretizing layer
\subsection{Parametrization and forward problem}

In practical situations, it is not possible to determine a continuous magnetic-moment distribution $p(x',y',z_c)$ over the layer as shown in equation \ref{eq:continuous_layer}. For this reason, the layer has to be approximated by a discrete set of dipoles with unit volume located at a constant depth $z = z_c$. By discretizing the integrand of equation \ref{eq:continuous_layer}, the predicted total-field anomaly at the point $(x_i,y_i,z_i)$ is given by 

\begin{equation}
\Delta T_i = f_i(\mathbf{s}) ,
\label{eq:tfa_pred_i}
\end{equation}    
where $\Delta T_i$ is the $i$th element of the $N$-dimensional vector of predicted total-field anomaly $\mathbf{\Delta T}(\mathbf{s})$. The function $f_i$ maps the unknown parameters onto the data, in which the parameter vector $\mathbf{s}$ is formed by an $M$-dimensional vector $\mathbf{p}$ whose $j$th element $p_j$ is the magnetic moment of the $j$th dipole with a single magnetization direction $\mathbf{q}$ (equation \ref{eq:q_vector}) assigned to all dipoles (Figure \ref{fig:eqlayer_figure}). Explicitly, the function $f_i$ is described as 

\begin{equation}
f_i (\mathbf{s}) = \sum_{j=1}^{M} g_{ij}(\mathbf{q}) p_j  = \mathbf{g}_{i}^T(\mathbf{q}) \mathbf{p},
\label{eq:f_i}
\end{equation}
where $\mathbf{g}_{i} (\mathbf{q})$ is a $M$-dimensional vector whose $ij$th element is given by

\begin{equation}
g_{ij} (\mathbf{q})  = \gamma_m \hat{\mathbf{F}}_0^T \mathbf{M}_{ij} \hat{\mathbf{m}}(\mathbf{q})
\label{eq:g_ij}
\end{equation}
and it is a harmonic function representing the total-field anomaly at the $i$th position $(x_i,y_i,z_i)$ yielded by a $j$th dipole located at $(x_j,y_j,z_c)$ with unit magnetic-moment intensity. The matrix $\mathbf{M}_{ij}$ is formed by the second derivatives of a function $\phi_{ij}$ that depends on the inverse of the scalar function $r_{ij} = [(x_i-x_j)^2 + (y_i-y_j)^2 + (z_i-z_c)^2]^{1/2}$, analogously to equations \ref{eq:H} and \ref{eq:phi}. From equations \ref{eq:tfa_pred_i}-\ref{eq:g_ij}, we can notice that the predicted total-field anomaly $\mathbf{\Delta T} (\mathbf{s})$ has a linear relation with the magnetic moment $\mathbf{p}$ and a nonlinear relation with the magnetizaion direction $\mathbf{q}$.    

\subsection{Inverse problem}

%%%% Defining the objective function
Let $\mathbf{\Delta T}^o$ be an \textit{N}-dimensional vector whose $i$th element $\Delta T_i^o$ is the total-field anomaly observation produced by a magnetic source at the point $(x_i,y_i,z_i)$, $i = 1, \ldots, N$. In order to estimate the magnetization direction, we have to formulate an inverse problem by imposing a positivity constraint on the magnetic-moment distribution. Here, it is accomplished by solving the following constrained problem of

\begin{subequations}
\begin{align}
& \text{minimizing}
& &\Psi(\mathbf{s}) =\lVert \mathbf{\Delta T}^o - \mathbf{\Delta T} (\mathbf{s}) \rVert_{2}^{2} + \, \mu f_0 \parallel \mathbf{p} \parallel_{2}^{2} \\
& \text{subject to}
& & \mathbf{p} \geqslant 0.
\end{align}
\label{eq:positivity_goal_function}
\end{subequations}
On the right side of equation \ref{eq:positivity_goal_function}a the first and second terms are the data-misfit function and the zeroth-order Tikhonov regularization function, $\mu$ is the regularizing parameter, $\| \cdot \|_{2}^{2}$ represents the squared Euclidean norm and $f_0$ is a normalizing factor. In the inequality \ref{eq:positivity_goal_function}b, $\mathbf{0}$ is a null vector and the inequality sign is applied element by element. This inequality imposes positivity constraints on the estimated magnetic moments of all dipoles, which is solved by using the nonnegative least squares (NNLS) proposed by \cite{lawson_hanson_1974}. 

%% Deducing the equations
Minimizing the goal function shown in equation \ref{eq:positivity_goal_function}a starts with an initial approximation $\mathbf{s}^k$ to the parameter vector and then solving a sequence of linear problem of estimating a correction $\mathbf{\Delta s}^k$ at each $k$th iteration. The procedure is repeated until a minimum of goal function (equation \ref{eq:positivity_goal_function}a) is reached. This procedure is determined by using a gradient-based iterative optimization method like Gauss-Newton \citep{aster2005}. Mathematically, the correction $\mathbf{\Delta s}^k$ is expressed as a second-order expansion of the goal function given by     

\begin{equation}
\Psi(\mathbf{s}^k + \mathbf{\Delta s}^k) \approx \Psi(\mathbf{s}^k) + \mathbf{J}^{k^T}(\mathbf{s}^k)  \mathbf{\Delta s}^k + 
\frac{1}{2} \mathbf{\Delta s}^{k^T} \mathbf{H}^k(\mathbf{s}^k) \mathbf{\Delta s}^k
\label{eq:sec_ord_goal}
\end{equation}
in which $\mathbf{J}^{k}(\mathbf{s}^k)$ and $\mathbf{H}^{k}(\mathbf{s}^{k})$ are, respectively, the gradient vector and the Hessian matrix of equation \ref{eq:positivity_goal_function}a. Thus, taking the gradient with respect to the parameter perturbation vector $\mathbf{\Delta s}^k$ of the expanded equation \ref{eq:sec_ord_goal} and setting the result equal to the null vector, it is obtained by solving the linear system

\begin{equation}
\mathbf{H}^k (\mathbf{s}^{k}) \bar{\mathbf{\Delta s}}^{k} = - \mathbf{J}^k (\mathbf{s}^k),
\label{eq:linear_sys_GN}
\end{equation}
where the estimate $\bar{\mathbf{\Delta s}}^{k}$ is a single step of the Gauss-Newton method required to attain the minimum of the expanded function (equation \ref{eq:sec_ord_goal}). The linear system given by equation \ref{eq:linear_sys_GN} can be rewritten as 

\begin{equation}
\left[
\begin{array}{c|c}
\mathbf{H}_{pp}^{k} & \mathbf{H}_{pq}^{k} \\
\hline
\mathbf{H}_{qp}^{k}& \mathbf{H}_{qq}^{k}
\end{array}
\right] \left[ \begin{array}{c}
\mathbf{\Delta p}^k \\ 
\mathbf{\Delta q}^k 
\end{array} \right] = -\left[ \begin{array}{c}
\mathbf{J}_{p}^{k} \\ 
\mathbf{J}_{q}^{k} 
\end{array} \right] ,
\label{eq:linear_sys_GN_block}
\end{equation}
in which $\mathbf{J}_{\alpha}^{k}$ and $\mathbf{H}_{\alpha \beta}^{k}$, where $\alpha = p,q$ and $\beta = p,q$, are the gradient vector and the Hessian matrix calculated in relation to each element of the magnetic-moment vector $\mathbf{p}$ and the magnetization direction vector $\mathbf{q}$, respectively. Besides, in order to simplify the equation \ref{eq:linear_sys_GN_block}, we consider null cross-derivatives. 

However, The gradient vector and the Hessian matrix relative to the part of magnetic moments are, respectively,

\begin{equation}
\mathbf{J}_{p}^{k} = -2 \mathbf{G}_{p}^{k^T} [ \mathbf{\Delta T}^o -  \mathbf{\Delta T} (\mathbf{s}^k) ] + 2\mu f_{0}^{k} \mathbf{p}^k 
\label{eq:grad_p}
\end{equation}   
and   

\begin{equation}
\mathbf{H}_{pp}^{k} = 2 \mathbf{G}_{p}^{k^T} \mathbf{G}_{p}^{k} + 2 \mu f_{0}^{k} \mathbf{I} 
\label{eq:hess_p}
\end{equation}
where $\mathbf{G}_p^{k}$ is the $N \times M$ sensitivity matrix at the $k$th iteration, whose $ij$th element is given by equation \ref{eq:g_ij}, $\mathbf{I}$ is an identity matrix and the normalizing factor $f_{0}^{k}$ is equal to

\begin{equation}
f_{0}^{k} = \dfrac{tr(\mathbf{G}_{p}^{k^T} \mathbf{G}_{p}^{k})}{M} \, ,
\label{eq:norm_factor}
\end{equation}
where $tr$ is denotaded as the trace of the matrix $\mathbf{G}_{p}^{k^T} \mathbf{G}_{p}^{k}$ and $M$ is the total number of dipoles composing the layer. From the correction $\bar{\mathbf{\Delta p}}^{k} = \bar{\mathbf{p}}^{k+1} - \bar{\mathbf{p}}^{k}$, we can conclude that the linear system to be solved is given by

\begin{equation}
\left[ \mathbf{G}_{p}^{k^T} \mathbf{G}_{p}^{k} + \mu f_{0}^{k} \mathbf{I} \right] \bar{\mathbf{p}}^{k+1} = \mathbf{G}_{p}^{k^T} \mathbf{\Delta T}^o.
\label{eq:linear_sys_p}
\end{equation} 
Owing to nonlinear relation of the magnetization direction $\mathbf{q}^k$ with the predicted total-field anomaly, the gradient vector and the Hessian matrix at the $k$th for this case are, respectively,

\begin{equation}
\mathbf{J}_{q}^{k} = -2 \mathbf{G}_{q}^{k^T} [ \mathbf{\Delta T}^o -  \mathbf{\Delta T} (\mathbf{s}^k) ] 
\label{eq:grad_q}
\end{equation}   
and   

\begin{equation}
\mathbf{H}_{qq}^{k} \approx 2 \mathbf{G}_{q}^{k^T} \mathbf{G}_{q}^{k} 
\label{eq:hess_q}
\end{equation}
in which $\mathbf{G}_q^k$ is a $N \times 2$ sensitivity matrix, whose elements are composed by derivative of equation \ref{eq:f_i} in relation of each element of the vector $\mathbf{q}^k$, that are the inclination and declination. Nevertheless, to calculate the correction $\bar{\mathbf{\Delta q}}^{k}$ at the $k$th iteration, we use the Levernberg-Marquardt method \citep{aster2005} by solving the linear system

\begin{equation}
\left[ \mathbf{G}_{q}^{k^T} \mathbf{G}_{q}^{k} + \lambda^k \mathbf{I} \right] \bar{\mathbf{\Delta q}}^{k} = \mathbf{G}_{q}^{k^T}[ \mathbf{\Delta T}^o -  \mathbf{\Delta T} (\mathbf{s}^k) ],
\label{eq:linear_sys_q}
\end{equation}
where $\lambda$ is the Marquardt parameter that is updated along the iterative process and $\mathbf{I}$ is an indentity matrix. After estimating the parameter correction $\bar{\mathbf{\Delta q}}^{k}$ at the $k$th iteration, we update the magnetization direction such that 

\begin{equation}
\bar{\mathbf{q}}^{k+1} = \bar{\mathbf{q}}^{k} + \bar{\mathbf{\Delta q}}^{k}.
\label{eq:q_next}
\end{equation}

\subsection{Iterative process for magnetization estimation}

The magnetic moments $\bar{\mathbf{p}}$ and the magnetization direction $\bar{\mathbf{q}}$ are obtained through an inverse problem of minimizing the difference between the observed data $ \mathbf{\Delta T}^o $ and the predicted data $\mathbf{\Delta T} (\mathbf{s})$. As we can notice, the solution of the inversion is given by solving two linear systems shown in equation \ref{eq:linear_sys_p} and equation \ref{eq:linear_sys_q}. For this reason, we propose a nested algorithm for solving the inverse problem in two steps.           

Our iterative algorithm starts with an initial guess for the magnetization direction $\mathbf{q}_0$. At the $k$th iteration, we estimate a set of magnetic moment $\bar{\mathbf{p}}^{k+1}$ by imposing a positivity constraint on equation \ref{eq:linear_sys_p}. After estimating the magnetic-moment distribution $\bar{\mathbf{p}}^{k+1}$ within the equivalent layer at the $k$th iteration using the previous estimate $\bar{\mathbf{q}}^{k}$ for the magnetization direction, we estimate the corrections of magnetization direction vector $\bar{\mathbf{\Delta q}}^{k}$ by solving the unconstrained nonlinear inverse problem (equation \ref{eq:linear_sys_q}) and update the magnetization direction by equation \ref{eq:q_next}. The iterative process stops when the goal function (equation \ref{eq:positivity_goal_function}a) is invariant along successive iterations. An overview of the algorithm is shown in Figure \ref{fig:scheme_LM_NNLS} and in the algorithm \ref{cd: LM_NNLS}. 

\begin{algorithm}[H]
	%\DontPrintSemicolon
	%\SetAlgoLined
	\SetKwInOut{Input}{Input}
	\SetKwInOut{Output}{Output}
	\Input{$\mathbf{\Delta T}^o$, $\mathbf{q}_0$}
	\Output{$\bar{\mathbf{p}}$,$\bar{\mathbf{q}}$}
	
	\While{(not converge)  or ($i<i_{max}$) }
	{ \textbf{step 1}: Solve equation \ref{eq:linear_sys_p} using NNLS \;
	  \textbf{step 2}: Compute goal function (equation \ref{eq:positivity_goal_function}a) \; 
	  \While{(not converge)  or ($j<j_{max}$) }
		{ \textbf{step 3}:  Initialize the Levenberg-Marquardt algorithm \;  
		  \textbf{step 4}: Compute goal function (equation \ref{eq:positivity_goal_function}a)\;
			\While{ $k<k_{marq}$ } {
				\textbf{step 5}:  Solve equation \ref{eq:linear_sys_q} \;
				\textbf{step 6}:  Update the magnetization direction estimate (equation \ref{eq:q_next}) \;
				\textbf{step 7}: Compute goal function (equation \ref{eq:positivity_goal_function})\;
			}
			\textbf{step 8}:  Analysis of convergence for inner loop.}
			\textbf{step 9}:  Analysis of convergence for outer loop.}
		
		\caption{Nested NNLS and Levenberg-Marquardt method}
		\label{cd: LM_NNLS}
	\end{algorithm}

\subsection{The choice of layer depth $\mathbf{z_c}$ and regularization parameter $\mathbf{\mu}$}

The procedure for the use of our methodology for estimating the total magnetization require the choice of two main parameters. The first one is the layer depth $z_c$ as shown in Figure \ref{fig:eqlayer_figure} and the second is the regularization parameter $\mu$ shown in equation \ref{eq:linear_sys_p}.

The method of the choice of layer is based on a classical approach proposed by \cite{dampney1969}. The author pointed out that the layer depth should satisfy an interval from $2.5$ to $6$ times the grid spacing. It should be notice that this rule was applied on an evenly spaced data. However, the choice for applying our method should correspond to an interval from $2$ to $3$ times the greater grid spacing. It is necessarily to point out that this range of values was found empirically due to the application on a irregular grid data.

To solve the equation \ref{eq:linear_sys_p} we have to choose a reliable regularization parameter $\mu$. For this purpose, we use the L-curve method \citep{hansen1992}. This approach is widely used in the literature to find a regularizing parameter, which filtering out enough noise without loosing to much information in the final solution. The procedure of finding the parameter plot a curve of optimal values between the solution norm and residual norm. The corner of the curve is the optimal regularization parameter which gives a threshold between the regularizing function and the data misfit.

\section{Methodology}
\label{sec:methodology}

\subsection{Fundamentals of magnetic equivalent layer}
\label{subsec:mag_eqlayer}

Considering a Cartesian coordinate system with $x$-, $y$- and $z$-axis being oriented to north, east and downward, respectively. Let $\Delta T_i \equiv \Delta T (x_i,y_i,z_i)$ be the total field anomaly, at the $i$-th position $(x_i,y_i,z_i)$, produced by a continuos layer located below the observation plane on the depth $z_c$, where $z_c > z_i$, and $p(x',y',z_c)$ is the distribution of magnetic dipoles per unit area over the layer surface. In this case, the total field anomaly produced by this continuous layer is given by the equation 

\begin{equation}
\Delta T_i = \int \limits_{-\infty}^{+\infty } \int \limits_{-\infty}^{+\infty }  p(x',y',z_c)  [\gamma_m \hat{\mathbf{F}}_0^T \mathbf{H} \,\hat{\mathbf{h}}(\mathbf{q})] dx' \,dy',
\label{eq:continuous_layer}
\end{equation}
where $\gamma_m$ is a constant proportional to the free space permeability, $\hat{\mathbf{F}}_0$ is a unit vector with the same direction of the geomagnetic field $\mathbf{F}_0$ given by

\begin{equation}
	\hat{\mathbf{F}}_0 =
	\left[ \begin{array}{c}
		 \cos I \cos D \\
		 \cos I \sin D \\
		 \sin I     
	\end{array} \right] ,
	\label{eq:main_field}
\end{equation}
where $I$ and $D$ are the inclination and declination of main field, respectively. The $\mathbf{H}$ is a $3 \times 3$ dimensional matrix equal to  

 \begin{equation}
   \mathbf{H} =
   \left[ \begin{array}{ccc}
   \partial_{xx} \phi & \partial_{xy} \phi &\partial_{xz} \phi \\  \partial_{yx} \phi & \partial_{yy} \phi &\partial_{yz} \phi \\  \partial_{zx} \phi &\partial_{zy}\phi  & \partial_{zz} \phi    
   \end{array} \right] ,
   \label{eq:H}
 \end{equation}
where $\partial_{\alpha \beta}\phi$, $\alpha = x, y, z$, $\beta = x, y, z$, is the second derivative of the function 

\begin{equation}
   \phi (x-x', y-y', z-z_c) = \frac{1}{[(x-x')^2 + (y-y')^2 + (z-z_c)^2]^{\frac{1}{2}}} .
   \label{eq:phi}
 \end{equation}
The $\hat{\mathbf{h}}(\mathbf{q})$ is a unit vector with the magnetization direction of the layer given by 

\begin{equation}
	\hat{\mathbf{h}}(\mathbf{q}) =
	\left[ \begin{array}{c}
		\cos \tilde{\i} \cos \tilde{d} \\
		\cos \tilde{\i} \sin \tilde{d}\\
		\sin \tilde{\i}
	\end{array} \right] 
	\label{eq:mag_vec}
\end{equation}
and $\mathbf{q}$ is a vector with components given by 

 \begin{equation}
   \mathbf{q} =
   \left[ \begin{array}{c}
   \tilde{\i} \\ 
   \tilde{d} 
   \end{array} \right] ,
   \label{eq:q_vector}
 \end{equation}
where $\tilde{\i} $ and $\tilde{d} $ is the inclination and declination of magnetization of the layer, respectively.

According the theory, we can reproduce a set of $N$ observed total field anomaly produced by a 3D magnetic source using a bidimensional physical-property distribution. In practical situations, the equivalent layer is composed by a set of $M$ equivalent sources distributed with a constant depth $h$ below the observation plane. It is worth pointing out that, in this work, the equivalent source is represented by a dipole with unit volume. For this reason, the vector $\mathbf{p}$ is the \textit{M}-dimensional vector defined as parameter vector, whose $j$th element is the magnetic intensity of the $j$th equivalent source, and the vector $\mathbf{q}$ contains the inclination and the declination of each equivalent dipole. By discretizing the integrand of equation \ref{eq:continuous_layer} in a set of points $(x_j,y_j,z_c)$, $j = 1, \ldots, M$, the integral can be given by

\begin{equation}
\Delta T_i (\mathbf{p},\mathbf{q})   = \sum_{j=1}^{M} p_j g_{ij} (\mathbf{q})
\label{eq:tfa_pred_pos_i}
\end{equation}    
where $p_j$ is the magnetic moment of $j$th equivalent source and 

\begin{equation}
g_{ij} (\mathbf{q})  = \gamma_m \hat{\mathbf{F}}_0^T \mathbf{H}_{ij} \hat{\mathbf{h}}(\mathbf{q})
\label{eq:g_ij}
\end{equation}
is a harmonic function that depends on the direction $\mathbf{q}$ of the dipole and the matrix $\mathbf{H}_{ij}$ is formed by the second derivatives of a function $\phi_{ij}$ that depends on the inverse of the function $r_{ij} = [(x_i-x_j)^2 + (y_i-y_j)^2 + (z_i-z_c)^2]^{1/2}$, analogously to equation \ref{eq:H} and \ref{eq:phi}.

Equation \ref{eq:tfa_pred_pos_i} represents the equivalent layer appproach. It is represented by the sum of the total field anomaly at the observation point $(x_i,y_i,z_i)$ produced by a set of $M$ ficticious equivalent sources, that is in this case a set of dipoles of unit volume, distributed on a horizontal plane at a constant depth $z_c$, each one with magnetic moment $p_j$ and magnetization direction $\mathbf{q}$. In matrix notation, the equation \ref{eq:tfa_pred_pos_i} can be represented as 

\begin{equation}
 \mathbf{\Delta T} (\mathbf{p}, \mathbf{q}) = \mathbf{G}(\mathbf{q}) \mathbf{p}
\label{eq:tfa_pred}
\end{equation}
where $\mathbf{G}$ is $N \times M$ matrix composed by the elements $g_{ij}$ of the equation \ref{eq:g_ij}.

% % Formulating the inverse problem explaining the iterative method

\subsection{Iterative process for magnetization estimation}

Let $\mathbf{\Delta T}^o$ be an \textit{N}-dimensional vector whose $i$th element $\Delta T_i^o$ is the total field anomaly observation produced by a magnetic source at the point $(x_i,y_i,z_i)$, $i = 1, \ldots, N$. The estimation of a set of magnetic moments $\mathbf{p}$ and the magnetization direction $\mathbf{q}$ consists to solve a inverse problem of minimizing the difference between the observed total field anomaly $\mathbf{\Delta T}^o$ and the predicted data $\Delta T (\mathbf{p}, \mathbf{q})$ by the equivalent layer (equation \ref{eq:tfa_pred}). In other words, a stable estimates $\mathbf{p}^\sharp$ and $\mathbf{q}^\sharp$ can be obtained by minimizing the objective function given by

\begin{equation}
\Psi(\mathbf{p}, \mathbf{q}) =  \parallel \mathbf{\Delta T}^o - \mathbf{\Delta T} (\mathbf{p}, \mathbf{q}) \parallel_{2}^{2},
\label{eq:misfit}
\end{equation}
where $\Psi(\mathbf{p}, \mathbf{q})$ is the data misfit, which is the Euclidean norm of the difference between the $\mathbf{\Delta T}^o$ and $\mathbf{\Delta T} (\mathbf{p}, \mathbf{q})$.

The procedure of finding a set of magnetic moment $\mathbf{p}^\sharp$ and magnetization direction $\mathbf{q}^\sharp$ which minimize the equation \ref{eq:misfit} consists to solve an inverse problem for estimating a set of paramaters in two steps. Therefore, we split the inverse problem in a mixed solution of two systems of equations: the first one solves a linear system for estimating the part of magnetic moment and the second is solved through a non-linear process to calculate successive approximations for the part of magnetization direction at each iteration along the process. 

Firstly, the starts with an initial step for the magnetization direction.

%The algorithm starts with an initial step for the magnetization direction $\mathbf{q}_0$. From its initial approximation, we consider, at the $k$th iteration, that the magnetic moment estimate $\mathbf{p}^k$ is calculated by the equation
%
%\begin{equation}
%	\mathbf{p}^k = (\mathbf{G}_{p}^{kT} \mathbf{G}_{p}^k)^{-1} \mathbf{G}_{p}^{kT}  \Delta \mathbf{T}^o
%	\label{eq:linsys_p}
%\end{equation}
%where $\mathbf{G}_p^k$ is the sensitivity matrix of the part of magnetic moment of equivalent sources at the $k$th iteration. The elements of this matrix are composed by derivative of equation \ref{eq:tfa_pred_pos_i} in relation of $j$th element of the vector $\mathbf{p}^k$. The equation \ref{eq:linsys_p} is the least squares estimator. Nevertheless, it is necessary to point out by imposing the magnetic moment vector $\mathbf{p}^k$ all positive during iterative process, we have a constraint such that
%
%\begin{equation}
%	\begin{aligned}
%		& \text{min}
%		& &\lVert \Delta \mathbf{T}^o - \mathbf{G}_p^k \mathbf{p}^k \rVert_2 \\
%		& \text{suj.}
%		& & \mathbf{p}^k \geqslant 0
%	\end{aligned}
%	\label{eq:positivity}
%\end{equation}
%where $\mathbf{p}^k \geqslant 0$ means that the magnetic moment of all equivalent sources are positive. This problem is solved using an algorithm of Nonnegative least squares proposed by \cite{lawson_and_hanson_1974}.
%
%However, we have to apply successive corrections $\Delta \mathbf{q}^k$ for calculating the magnetization direction vector $\mathbf{q}^k$ at each $k$th iteration. It is calculated using the Levenberg-Marquardt method (\cite{aster2005}), that is given by equation   
%
%\begin{equation}
%	\Delta \mathbf{q}^k = (\mathbf{G}_{q}^{kT} \mathbf{G}_{q}^k + \lambda \mathbf{I})^{-1} \mathbf{G}_{q}^{kT}  \mathbf{r}^k
%	\label{eq:linsys_q}
%\end{equation}
%where $\mathbf{G}_q^k$ is the sensitivity matrix of the part of magnetization direction of equivalent sources at the $k$th iteration, $\lambda$ is the Marquardt parameter that is update along the iterative process and $\mathbf{I}$ is a indentity matrix. The elements of the matrix $\mathbf{G}_q^k$ are composed by derivative of equation \ref{eq:tfa_pred_pos_i} in relation of each component of the magnetization direction vector $\mathbf{q}^k$, that are the inclination and declination, respectively. The correction is given by
%
%\begin{equation}
%	\mathbf{q}^{k+1} = \mathbf{q}^k + \Delta\mathbf{q}^k,
%	\label{eq:q_correction}
%\end{equation}
%and residual $\mathbf{r}^k$ is equal to 
%
%\begin{equation}
%	\mathbf{r}^k = \Delta \mathbf{T^o} -  \Delta \mathbf{T} (\mathbf{p}^k, \mathbf{q}^k).
%	\label{eq:residual_k}
%\end{equation}
%The iterative process stops when the data-misfit function (equation \ref{eq:misfit}) is invariant along succesive iterations according a stop criterion.




% Constraining the magnetic moment of equivalent sources

% % Generalization of all-positive equivalent sources 




